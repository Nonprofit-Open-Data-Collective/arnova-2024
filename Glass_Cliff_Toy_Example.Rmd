---
title: "Glass Cliff Toy Example"
author: "Tiana Marrese"
date: "2024-11-18"
output: html_document
runtime: shiny
---


# Nonprofits and the Glass Cliff
## A Research Exploration

This script will present several new components of the Nonprofit Open Data Collective through a toy example investigating the "Glass Cliff phenomenon" or the idea the women are more likely to be appointed to precarious positions of power relative to their male counterparts. We will specifically highlight the integrated data environment and the numerous resources available for research on the third sector. 


### Important Resources

[Data Catalog](https://nccs.urban.org/nccs/catalogs/catalog-efile.html)
\
[Data Dictionary](https://nonprofit-open-data-collective.github.io/irs990efile/data-dictionary/data-dictionary.html)
\
[Open Data Collective Landing Page](https://nonprofit-open-data-collective.github.io/tools/)



```{r setup, include=FALSE}

#devtools::install_github( "Nonprofit-Open-Data-Collective/peopleparser" )
#devtools::install_github( 'nonprofit-open-data-collective/titleclassifier' )
#devtools::install_github('nonprofit-open-data-collective/fiscal')

library(dplyr)
library(peopleparser)
library(titleclassifier)
library( fiscal )
library(tidyr)
library(RecordLinkage)
library(stringr)
library(reshape2)
library(ggplot2)
library(ggrepel)

#Change working directory to personal path
setwd("~/Tiana_School_Work/PhD/Dissertation/Glass_Cliff_Paper")

```



### Getting Main Data

Processed IRS 990 Efile data are housed in the [Data Catalog](https://nccs.urban.org/nccs/catalogs/catalog-efile.html) with the respective [data dictionaries ](https://nonprofit-open-data-collective.github.io/irs990efile/data-dictionary/data-dictionary.html). You can find further information on these sites about sources, processing, and final parsing. 
\
\
For our toy example, we are particularly interested in the part of the 990 forms that collect information about the board members of the nonprofit. This is known as Part VII data. We will begin by pulling two years of this data. 
\
\
There are two main ways to access the data. You can download the data locally to your computer from the data catalog and read it into your R environment or you can use pre-built functions to read it directly in R. We present examples of both below. 
```{r}

#Reading in locally store data
df2010 <- read.csv( "Coding/Data/PartVII/PartVII-2010.csv" )
df2011 <- read.csv( "Coding/Data/PartVII/PartVII-2011.csv" )



#Pre-built functions:
nodc <- "https://raw.githubusercontent.com/Nonprofit-Open-Data-Collective/"
repo <- "arnova-2024/refs/heads/main/"
file <- "functions.R"
source( paste0( nodc, repo, file ) )


df2010.fun <- get_partvii(2010)
df2011.fun <- get_partvii(2011)



```



### Preparing Main Data

The main variables of interest in these data are the board member names and their titles. We will create a data frame that contains both years of our data then we will utilize pre-built packages from the [Nonprofit Open Data Repositories](https://github.com/orgs/Nonprofit-Open-Data-Collective/repositories) to clean these variables further (the packages are `peopleparser` and `titleclassifier`). Eventually, pre-cleaned versions of the data will be available for download but for now we highlight the steps to utilize these packages directly. 


```{r, results = 'hide'}

#First, we want to combine the two years of data
#For simplicity, we will only work with the data pulled locally. 

#We need to:
#Remove "X" columns from the dfs that have this
#Also remove "average hours for related org (COMP_DTK_AVE_HOUR_WEEK_RL)" since this isn't present in all of them
#You could alternatively add a column of this variable to the dfs that don't have this, we don't this var so we will remove it

df2011 <- df2011 %>% select(-c( "X", "F9_07_COMP_DTK_AVE_HOUR_WEEK_RL"))

#Let's put them all together
df <- rbind(df2010, df2011)


#The packages to clean the name and title variables can take a bit to run. So before initiating them, we can make some assumptions about the observations we want. We are specifically interested in locating paid CEOs of NP. We will assume these positions must make more than $1 and work more than 15 hours

df_sub <- df %>% filter(!is.na(F9_07_COMP_DTK_COMP_ORG) &
                      F9_07_COMP_DTK_COMP_ORG > 1  &
                      !is.na(F9_07_COMP_DTK_AVE_HOUR_WEEK) &
                      F9_07_COMP_DTK_AVE_HOUR_WEEK > 15
                      )

#For simplicity and to limit run time, we will take the first 1000 observations and perform the rest of the lines. You can comment out the next line if you would like to do the entire df (but be aware that it will take a bit of time to run)

df_sub <- df_sub[1:1000,]


####################################
#Peopleparser 
#https://github.com/Nonprofit-Open-Data-Collective/peopleparser
####################################

#Now let's use peopleparser to clean the names. This function can take a bit to run so let's further limit our df to only unique names
df_unique_names <- df_sub %>% select(F9_07_COMP_DTK_NAME_PERS) %>%
  distinct()


#Now doing people parser
df_names <- parse.names(df_unique_names$F9_07_COMP_DTK_NAME_PERS)

#We can left_join  these names back onto the df
df_sub <- df_sub %>% left_join(df_names, by = c("F9_07_COMP_DTK_NAME_PERS" = "name"))


####################################
#Titleclassifier 
#https://github.com/Nonprofit-Open-Data-Collective/titleclassifier
####################################

#Since this function also takes a bit of time, we will narrow down the titles to their unique occurrences based on the vars input to the function
df_unique_titles <- df_sub %>% 
  distinct(F9_07_COMP_DTK_TITLE,
             FORMTYPE,
             F9_07_COMP_DTK_AVE_HOUR_WEEK,  
             F9_07_COMP_DTK_COMP_ORG, 
             F9_07_COMP_DTK_EMPL_BEN, 
             F9_07_COMP_DTK_COMP_RLTD, 
             F9_07_COMP_DTK_COMP_OTH,
             F9_07_COMP_DTK_POS_INDIV_TRUST_X, 
             F9_07_COMP_DTK_POS_INST_TRUST_X, 
             F9_07_COMP_DTK_POS_OFF_X, 
             F9_07_COMP_DTK_POS_KEY_EMPL_X, 
             F9_07_COMP_DTK_POS_HIGH_COMP_X, 
             F9_07_COMP_DTK_POS_FORMER_X,
             F9_07_COMP_DTK_NAME_PERS  , .keep_all = T)


#Running the title classifier now
df_titles <-  df_unique_titles %>% 
  standardize_df() %>% 
  remove_dates() %>% 
  standardize_conj() %>% 
  split_titles() %>% 
  standardize_spelling() %>% 
  gen_status_codes() %>% 
  standardize_titles() %>%
  categorize_titles()


#Let's select only the columns we need to put back onto the original dataset
#Note: the title classifier seems to only keep unique rows by a person's name, not each occurrence they have. So columns like hours worked and pay by individual are not completely correct. But the total info about the org should be fine to keep
df_titles <- df_titles %>% select(ein, dtk.name, title.raw, 
                                       title.standard, title.mult.x, title.order, title.count, 
                                       num.paid, num.fte, num.fte.30h)


#now we join back to df_sub
#df_titles_mnr will create multiple rows for people that list "x/y" in their title
#So we want to do a full join where we keep all rows from both
df_sub_names_titles <- df_sub %>% full_join(df_titles, by = c("EIN"= "ein",
                                                     "F9_07_COMP_DTK_NAME_PERS" = "dtk.name",
                                                      "F9_07_COMP_DTK_TITLE" = "title.raw"),
                                            relationship = "many-to-many")




```



### Glass Cliff Analysis

There are several data cleaning and preparation steps that should be performed to prepare the base data for our analysis. These are beyond the scope of this toy example. Instead, we provide a cleaned subset of the data. We will look at 1000 unique nonprofits that experienced at least one CEO transition between 2009 and 2019. It should be noted that it is possible for these organizations to experience more than one transition during this time frame. As such, we have a total of 1067 transitions. We can analyze various facets of these transitions. 


```{r}

df_long <- readRDS("Coding/Data/toy_df.RDS")

```


#### Financial Data Joining
The first thing we want to do with these data are to add financial information about the orgs during each respective year. We will again pull this data from the open data collective. 



```{r, results = 'hide'}

summary2009 <- get_table( "F9-P01-T00-SUMMARY", year=2009 )
summary2010 <- get_table( "F9-P01-T00-SUMMARY", year=2010 )
summary2011 <- get_table( "F9-P01-T00-SUMMARY", year=2011 )
summary2012 <- get_table( "F9-P01-T00-SUMMARY", year=2012 )
summary2013 <- get_table( "F9-P01-T00-SUMMARY", year=2013 )
summary2014 <- get_table( "F9-P01-T00-SUMMARY", year=2014 )
summary2015 <- get_table( "F9-P01-T00-SUMMARY", year=2015 )
summary2016 <- get_table( "F9-P01-T00-SUMMARY", year=2016 )
summary2017 <- get_table( "F9-P01-T00-SUMMARY", year=2017 )
summary2018 <- get_table( "F9-P01-T00-SUMMARY", year=2018 )
summary2019 <- get_table( "F9-P01-T00-SUMMARY", year=2019 )

expenses2009 <- get_table( "F9-P09-T00-EXPENSES", year=2009 )
expenses2010 <- get_table( "F9-P09-T00-EXPENSES", year=2010 )
expenses2011 <- get_table( "F9-P09-T00-EXPENSES", year=2011 )
expenses2012 <- get_table( "F9-P09-T00-EXPENSES", year=2012 )
expenses2013 <- get_table( "F9-P09-T00-EXPENSES", year=2013 )
expenses2014 <- get_table( "F9-P09-T00-EXPENSES", year=2014 )
expenses2015 <- get_table( "F9-P09-T00-EXPENSES", year=2015 )
expenses2016 <- get_table( "F9-P09-T00-EXPENSES", year=2016 )
expenses2017 <- get_table( "F9-P09-T00-EXPENSES", year=2017 )
expenses2018 <- get_table( "F9-P09-T00-EXPENSES", year=2018 )
expenses2019 <- get_table( "F9-P09-T00-EXPENSES", year=2019 )

balance2009 <- get_table( "F9-P10-T00-BALANCE-SHEET", year=2009 )
balance2010 <- get_table( "F9-P10-T00-BALANCE-SHEET", year=2010 )
balance2011 <- get_table( "F9-P10-T00-BALANCE-SHEET", year=2011 )
balance2012 <- get_table( "F9-P10-T00-BALANCE-SHEET", year=2012 )
balance2013 <- get_table( "F9-P10-T00-BALANCE-SHEET", year=2013 )
balance2014 <- get_table( "F9-P10-T00-BALANCE-SHEET", year=2014 )
balance2015 <- get_table( "F9-P10-T00-BALANCE-SHEET", year=2015 )
balance2016 <- get_table( "F9-P10-T00-BALANCE-SHEET", year=2016 )
balance2017 <- get_table( "F9-P10-T00-BALANCE-SHEET", year=2017 )
balance2018 <- get_table( "F9-P10-T00-BALANCE-SHEET", year=2018 )
balance2019 <- get_table( "F9-P10-T00-BALANCE-SHEET", year=2019 )

#Let's put them all together
summary <- rbind(as.data.frame(summary2009), as.data.frame(summary2010),as.data.frame(summary2011),
                 as.data.frame(summary2012),as.data.frame(summary2013),as.data.frame(summary2014), 
                 as.data.frame(summary2015),as.data.frame(summary2016),as.data.frame(summary2017),
                 as.data.frame(summary2018),as.data.frame(summary2019))

expenses <- rbind(as.data.frame(expenses2009),as.data.frame(expenses2010),as.data.frame(expenses2011),
                  as.data.frame(expenses2012),as.data.frame(expenses2013),as.data.frame(expenses2014), 
                  as.data.frame(expenses2015),as.data.frame(expenses2016),as.data.frame(expenses2017),
                  as.data.frame(expenses2018),as.data.frame(expenses2019))

balance <- rbind(as.data.frame(balance2009),as.data.frame(balance2010),as.data.frame(balance2011),
                 as.data.frame(balance2012),as.data.frame(balance2013),as.data.frame(balance2014), 
                 as.data.frame(balance2015),as.data.frame(balance2016),as.data.frame(balance2017),
                 as.data.frame(balance2018),as.data.frame(balance2019))


#Orgs can return various versions of their tax forms each year
#For now, we will keep only the first observation, true analysis will need to revisit this decision
summary <- summary %>% group_by(ORG_EIN, TAX_YEAR) %>%
  filter(row_number()==1)

expenses <- expenses %>% group_by(ORG_EIN, TAX_YEAR) %>%
  filter(row_number()==1)

balance <- balance %>% group_by(ORG_EIN, TAX_YEAR) %>%
  filter(row_number()==1)

#Let's join everything together


df_long_fncl <- df_long %>% left_join(summary, by = c("TAXYR" = "TAX_YEAR",
                                                              "EIN" = "ORG_EIN"))

df_long_fncl <- df_long_fncl %>% left_join(expenses, by = c("TAXYR" = "TAX_YEAR",
                                                                   "EIN" = "ORG_EIN"))

df_long_fncl <- df_long_fncl %>% left_join(balance, by = c("TAXYR" = "TAX_YEAR",
                                                                   "EIN" = "ORG_EIN"))


```


#### Summary Statistics of Transitions

Now we're ready for some analyses! We are most interested in understanding transitions by their gendering. That is to say that we want to know if there are differences in observable firm dimensions for nonprofits that experience a CEO transition from male to male relative to the other permutations of male to female, female to male, and female to female. Let's start by looking at org differences by these transition types. For simplicity, we will only consider a few firm dimensions such as employee size and total assets.



```{r}


#First need to denote transitions 
df_long_fncl <- df_long_fncl %>%
  arrange(EIN, transition_no, TAXYR)%>% #for each org, transition, and year, 
  group_by(EIN, transition_no) %>%       
  mutate(period = row_number())%>%       #let's denote which period the row is relative to (i.e., how many years before /after a transition)
  ungroup()

#Let's make this variable a bit more readable
df_long_fncl$period <- paste0("T", df_long_fncl$period-3)
df_long_fncl$period <- factor(df_long_fncl$period, levels = c("T-2", "T-1", "T0" , "T1", "T2"))


#Need to get transition type too
#We want to know if the transition is M>M, M>F, F>M, or F>M
#We will first create a string of the CEO gender throughout the 5 year period
#The we will create a column that keeps the first and last gender (this is the gender transition)
df_long_fncl<- df_long_fncl %>%
  group_by(EIN, transition_no)%>%
  mutate(trans_tot = str_c(unlist(strsplit(paste(gender, collapse = ""), "")), collapse = "")
  ) %>%
  mutate(
    trans_type = str_sub(trans_tot, 1, 1) %>%
      str_c(str_sub(trans_tot, nchar(trans_tot), nchar(trans_tot)))  # Combine 1st and last letter
    
  )

#We want this variable to be a factor
df_long_fncl$trans_type <- as.factor(df_long_fncl$trans_type)



#We're going to get firm attributes by transition type
#Let's consider the attributes at t-1
#We'll consider basic variables like number of employees, total assets, etc.

#Note that further data cleaning is necessary for final presentation due to NA values input into some of these columns. For now, we will just remove the nas and continue with our analysis

temp <- df_long_fncl %>% group_by(trans_type)%>%
  filter(period == "T-1") %>%
  summarize(count = n(),
    num_emp_av =mean(F9_01_ACT_GVRN_EMPL_TOT, na.rm = T),
            num_emp_sd = sd(F9_01_ACT_GVRN_EMPL_TOT, na.rm = T),
            num_vol_av = mean(F9_01_ACT_GVRN_VOL_TOT, na.rm = T),
            num_vol_sd = sd(F9_01_ACT_GVRN_VOL_TOT, na.rm = T),
            total_exp_av = mean(F9_01_EXP_TOT_PY, na.rm = T),
            total_exp_sd = sd(F9_01_EXP_TOT_PY, na.rm = T),
            total_assets_av = mean(F9_01_NAFB_ASSET_TOT_BOY, na.rm = T),
            total_assets_sd = sd(F9_01_NAFB_ASSET_TOT_BOY, na.rm = T))

temp


```





#### Financial Measures by Transitions

The Glass Cliff Phenomenon hypothesizes that women are chosen for positions of power when these positions are more precarious. One way to denote a precarious position is by the firm's financial performance. We will specifically focus on two financial performance metrics: debt to asset ratio (dar) and program efficiency ratio (per). While a more robust analysis calls for consideration of more dimensions and further data cleaning on these variables, we will simply highlight how to perform an analysis using these variables. We will use the package `fiscal` from the Open Data Collective to calculate our variables of interest. The default parameters of the respective functions are already built for the 990 naming conventions so usage is pretty straight forward!


```{r, message = F, warning = F}

#Calculating the respective vars
#https://github.com/Nonprofit-Open-Data-Collective/fiscal/tree/main/R
df_long_fncl <- as.data.frame(df_long_fncl)


df_long_fncl <- get_dar(df_long_fncl)
df_long_fncl <- get_per(df_long_fncl)


#Let's plot these measures

plot_temp <- df_long_fncl %>%
  group_by(trans_type, period)%>%
  summarize(mean_dar =mean(dar, na.rm = T),
            sd_dar =sd(dar, na.rm = T))


ggplot(data = plot_temp, aes(x = period, y = mean_dar, group = trans_type, color = trans_type)) + 
  geom_line(linewidth = 1.5)+ 
  geom_text_repel(aes(label = round(mean_dar,2)), size = 5, nudge_x = -0.07, nudge_y = 0.0029, segment.size = 0, segment.color = NA)+
  theme_bw( ) + 
  theme(text = element_text(size = 24))+
  scale_x_discrete(labels = c("T-2", "T-1", "Transition", "T+1", "T+2"))+
  labs(color = "Transition") +
  xlab("Period")+
  ylab("Debt to Total Asset Ratio") +
  ggtitle("Debt to Total Asset Ratio by Transition Type") +
  geom_vline(xintercept = 3, linetype = "dashed")


plot_temp <- df_long_fncl %>%
  group_by(trans_type, period)%>%
  summarize(mean_per =mean(per, na.rm = T),
            sd_per =sd(per, na.rm = T))



ggplot(data = plot_temp, aes(x = period, y = mean_per, group = trans_type, color = trans_type)) + 
  geom_line(size = 1.5)+ 
  geom_text_repel(aes(label = round(mean_per,1)), size = 5, nudge_x =- 0.02,
                  segment.size = 0, segment.color = NA)+
  theme_bw( ) + 
  theme(text = element_text(size = 24))+
  scale_x_discrete(labels = c("T-2", "T-1", "Transition", "T+1", "T+2"))+
  labs(color = "Transition") +
  xlab("Period")+
  ylab("Program Efficiency Ratio") +
  ggtitle("Program Efficiency Ratio by Transition Type") +
  geom_vline(xintercept = 3, linetype = "dashed")


################################################
#Now doing density plots of these respective vars
################################################

#Let's compare the MM density to MF density in the t-1 period for the vats

df_long_fncl_MM <- df_long_fncl %>% filter(trans_type == "MM" &
                                             period == "T-1")
df_long_fncl_MF <- df_long_fncl %>% filter(trans_type == "MF"&
                                             period == "T-1")


ggplot() + 
  geom_density(data = df_long_fncl_MM,  aes(x = dar, fill = "lightblue"), alpha = 0.5) +
  geom_density(data = df_long_fncl_MF,  aes(x = dar, fill = "pink"), alpha = 0.5) +
  xlim(-1,3)+
  theme_bw()+
#  theme(text = element_text(size = 24))+
  scale_fill_manual(name = "Transition", values = c('lightblue', 'pink'), labels = c("pink" = "MF" ,  "lightblue" = "MM") ) +
  xlab("Debt to Total Asset Ratio")+
  ylab("Density") +
  ggtitle("Density of Debt to Asset Ratio by Transition at t-1") 
  

ggplot() + 
  geom_density(data = df_long_fncl_MM,  aes(x = per, fill = "lightblue"), alpha = 0.5) +
  geom_density(data = df_long_fncl_MF,  aes(x = per, fill = "pink"), alpha = 0.5) +
  xlim(-1, 3)+
  theme_bw()+
 # theme(text = element_text(size = 24))+
  scale_fill_manual(name = "Transition", values = c('lightblue', 'pink'), labels = c("pink" = "MF" ,  "lightblue" = "MM") ) +
  xlab(" Program Efficiency Ratio")+
  ylab("Density") +
  ggtitle("Program Efficiency Ratio by Transition at t-1") 



```





